name: SignPath Code Signing

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'GitHub artifact name to sign'
        required: true
        type: string
      artifact-id:
        description: 'GitHub artifact ID to sign'
        required: true
        type: string
      version:
        description: 'Version string for signing'
        required: true
        type: string
      is-release:
        description: 'Whether this is a release build'
        required: false
        type: boolean
        default: false
    secrets:
      SIGNPATH_API_TOKEN:
        description: 'SignPath API Token'
        required: true
    outputs:
      signed-artifact-id:
        description: 'ID of the signed artifact'
        value: ${{ jobs.sign.outputs.signed-artifact-id }}
      signing-request-id:
        description: 'SignPath signing request ID'
        value: ${{ jobs.sign.outputs.signing-request-id }}

jobs:
  sign:
    runs-on: ubuntu-latest
    outputs:
      signed-artifact-id: ${{ steps.upload-signed.outputs.artifact-id }}
      signing-request-id: ${{ steps.signpath-submit.outputs.signing-request-id }}
    
    steps:
    - name: Download unsigned artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./unsigned-artifacts
        
    - name: Display artifact contents
      run: |
        echo "=== All contents of unsigned artifacts ==="
        find ./unsigned-artifacts -type f -exec ls -la {} \;
        echo ""
        echo "=== .exe files in unsigned artifacts ==="
        find ./unsigned-artifacts -name "*.exe" -exec ls -la {} \;
        echo ""
        echo "=== Non-UPX .exe files ==="
        find ./unsigned-artifacts -name "*.exe" ! -name "*upx*" -exec ls -la {} \;
        
    - name: Create signing directory
      run: |
        mkdir -p ./signing-input
        mkdir -p ./signed-output
        
        echo "=== Filtering files for signing ==="
        
        # 尝试不同的筛选策略
        echo "Strategy 1: 排除包含 'upx' 的文件"
        find ./unsigned-artifacts -name "*.exe" ! -name "*upx*" -exec cp {} ./signing-input/ \; || true
        
        FILE_COUNT=$(find ./signing-input -name "*.exe" | wc -l)
        echo "Strategy 1 result: $FILE_COUNT files"
        
        if [ "$FILE_COUNT" -eq 0 ]; then
          echo "Strategy 2: 排除包含 '_upx' 的文件"
          find ./unsigned-artifacts -name "*.exe" ! -name "*_upx*" -exec cp {} ./signing-input/ \; || true
          FILE_COUNT=$(find ./signing-input -name "*.exe" | wc -l)
          echo "Strategy 2 result: $FILE_COUNT files"
        fi
        
        if [ "$FILE_COUNT" -eq 0 ]; then
          echo "Strategy 3: 复制所有 .exe 文件，稍后手动排除"
          find ./unsigned-artifacts -name "*.exe" -exec cp {} ./signing-input/ \; || true
          
          # 手动删除 UPX 压缩的版本
          rm -f ./signing-input/*upx*.exe ./signing-input/*_upx*.exe ./signing-input/*UPX*.exe || true
          
          FILE_COUNT=$(find ./signing-input -name "*.exe" | wc -l)
          echo "Strategy 3 result: $FILE_COUNT files"
        fi
        
        echo ""
        echo "=== Final files to be signed ==="
        ls -la ./signing-input/
        
    - name: Create ZIP archive for signing
      run: |
        echo "=== Files in signing-input directory ==="
        ls -la ./signing-input/
        
        cd ./signing-input
        
        # 检查是否有 .exe 文件
        EXE_COUNT=$(find . -maxdepth 1 -name "*.exe" | wc -l)
        echo "Found $EXE_COUNT .exe files to sign"
        
        if [ "$EXE_COUNT" -eq 0 ]; then
          echo "Error: No .exe files found for signing!"
          echo "This will cause SignPath to fail."
          exit 1
        fi
        
        # 创建 ZIP 文件
        zip -r ../catime-unsigned.zip *.exe
        cd ..
        
        echo "=== Created ZIP archive for signing ==="
        ls -la catime-unsigned.zip
        echo ""
        echo "=== Contents of ZIP file ==="
        unzip -l catime-unsigned.zip
        
    - name: Upload signing package as artifact
      id: upload-signing-package
      uses: actions/upload-artifact@v4
      with:
        name: catime-signing-package
        path: catime-unsigned.zip
        retention-days: 1
        
    - name: Submit to SignPath for signing
      id: signpath-submit
      uses: signpath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: '66aa6e96-a394-43f9-b3c3-65214fcd285d'
        project-slug: 'Catime'
        signing-policy-slug: ${{ inputs.is-release && 'release-signing' || 'test-signing' }}  # 根据是否是发布版本选择不同的签名策略
        github-artifact-id: ${{ steps.upload-signing-package.outputs.artifact-id }}
        wait-for-completion: true
        output-artifact-directory: './signed-output'
        parameters: |
          version: ${{ toJSON(inputs.version) }}
          build_type: ${{ toJSON(inputs.is-release && 'release' || 'development') }}
          
    - name: Extract signed files
      run: |
        echo "Signed output directory contents:"
        find ./signed-output -type f -exec ls -la {} \;
        
        # 如果签名输出是ZIP文件，需要解压
        if find ./signed-output -name "*.zip" | grep -q .; then
          echo "Found ZIP file, extracting..."
          cd ./signed-output
          find . -name "*.zip" -exec unzip -o {} \;
          cd ..
        fi
        
        echo "Final signed files:"
        find ./signed-output -name "*.exe" -exec ls -la {} \;
        
    - name: Verify signed files exist
      run: |
        SIGNED_FILES=$(find ./signed-output -name "*.exe" | wc -l)
        if [ "$SIGNED_FILES" -eq 0 ]; then
          echo "Error: No signed .exe files found!"
          exit 1
        fi
        echo "Found $SIGNED_FILES signed executable files"
        
    - name: Upload signed artifacts
      id: upload-signed
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}-signed
        path: ./signed-output/*.exe
        retention-days: 90
        
    - name: Create signing summary
      run: |
        echo "## 🔐 Code Signing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ inputs.is-release && 'Release' || 'Development' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Signing Request ID:** ${{ steps.signpath-submit.outputs.signing-request-id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Original Artifact:** ${{ inputs.artifact-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Signed Artifact:** ${{ inputs.artifact-name }}-signed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Signed Files:" >> $GITHUB_STEP_SUMMARY
        find ./signed-output -name "*.exe" -exec basename {} \; | while read file; do
          echo "- ✅ $file" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🔗 [View SignPath Request](${{ steps.signpath-submit.outputs.signing-request-web-url }})" >> $GITHUB_STEP_SUMMARY
